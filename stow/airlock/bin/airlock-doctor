#!/usr/bin/env bash
set -euo pipefail

fail() { echo "FAIL: $*" >&2; exit 1; }
ok() { echo "OK: $*"; }

AIRLOCK_ENGINE="${AIRLOCK_ENGINE:-podman}"
AIRLOCK_HOME="${AIRLOCK_HOME:-$HOME/.airlock}"
CODEX_STATE_DIR="${CODEX_STATE_DIR:-$AIRLOCK_HOME/codex-state}"
AIRLOCK_CODEX_HOME_MODE="${AIRLOCK_CODEX_HOME_MODE:-host}"

req() { [[ -e "$1" ]] || fail "missing: $1"; }

req "$AIRLOCK_HOME/policy/codex.config.toml"
req "$AIRLOCK_HOME/image/agent.Dockerfile"
req "$HOME/bin/yolo"
req "$HOME/bin/airlock-build"
req "$HOME/bin/airlock-doctor"

command -v "$AIRLOCK_ENGINE" >/dev/null || fail "container engine not found: $AIRLOCK_ENGINE"
if "$AIRLOCK_ENGINE" info >/dev/null 2>&1; then
  ok "engine reachable: $AIRLOCK_ENGINE"
else
  fail "engine not reachable (is it running and configured?): $AIRLOCK_ENGINE"
fi

if [[ "${AIRLOCK_MOUNT_ENGINE_SOCKET:-1}" != "0" ]]; then
  if [[ "$AIRLOCK_ENGINE" == "docker" ]]; then
    if [[ -S /var/run/docker.sock ]]; then
      ok "docker socket present: /var/run/docker.sock"
    else
      echo "WARN: docker socket not found at /var/run/docker.sock"
      echo "      Container builds from inside yolo will not work until the socket is available."
    fi
  elif [[ "$AIRLOCK_ENGINE" == "podman" ]]; then
    sock=""
    for candidate in \
      "${XDG_RUNTIME_DIR:-/run/user/$(id -u)}/podman/podman.sock" \
      "/run/user/$(id -u)/podman/podman.sock" \
      "/run/podman/podman.sock"
    do
      if [[ -S "$candidate" ]]; then
        sock="$candidate"
        break
      fi
    done

    if [[ -n "$sock" ]]; then
      ok "podman socket present: $sock"
    else
      echo "WARN: podman socket not found (podman CLI works, but builds from inside yolo need a socket)."
      echo "      Try enabling the user socket (systemd):"
      echo "        systemctl --user enable --now podman.socket"
      echo "      If user systemd isn't available, run a one-shot service instead:"
      echo "        podman system service --time=0 \"unix:///run/user/$(id -u)/podman/podman.sock\""
    fi
  fi
fi

IMAGE="${AIRLOCK_IMAGE:-airlock-agent:local}"
if "$AIRLOCK_ENGINE" image inspect "$IMAGE" >/dev/null 2>&1; then
  ok "agent image present: $IMAGE"
else
  echo "WARN: agent image missing: $IMAGE (run: airlock-build)"
fi

if [[ "$AIRLOCK_CODEX_HOME_MODE" == "host" ]]; then
  if [[ -f "$HOME/.codex/auth.json" ]]; then
    ok "codex auth present (host): $HOME/.codex/auth.json"
  else
    echo "WARN: codex auth not found at $HOME/.codex/auth.json (codex will prompt on first run)"
  fi
else
  if [[ -f "$CODEX_STATE_DIR/auth.json" ]]; then
    ok "codex auth present: $CODEX_STATE_DIR/auth.json"
  elif [[ -f "$HOME/.codex/auth.json" ]]; then
    echo "WARN: codex auth missing in Airlock state: $CODEX_STATE_DIR/auth.json"
    echo "      To reuse your host login, copy it into Airlock state:"
    echo "        mkdir -p \"$CODEX_STATE_DIR\" && cp \"$HOME/.codex/auth.json\" \"$CODEX_STATE_DIR/auth.json\" && chmod 600 \"$CODEX_STATE_DIR/auth.json\""
  else
    echo "WARN: codex auth not found. First run will prompt for login and persist it under:"
    echo "      $CODEX_STATE_DIR/auth.json"
  fi
fi

ok "basic checks complete"
