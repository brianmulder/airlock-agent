#!/usr/bin/env bash
set -euo pipefail

fail() { echo "FAIL: $*" >&2; exit 1; }
ok() { echo "OK: $*"; }

AIRLOCK_ENGINE="${AIRLOCK_ENGINE:-podman}"
AIRLOCK_HOME="${AIRLOCK_HOME:-$HOME/.airlock}"
AIRLOCK_CONFIG_DIR="${AIRLOCK_CONFIG_DIR:-$AIRLOCK_HOME/config}"
AIRLOCK_ZSHRC="${AIRLOCK_ZSHRC:-$AIRLOCK_CONFIG_DIR/zshrc}"

req() { [[ -e "$1" ]] || fail "missing: $1"; }

req "$AIRLOCK_HOME/image/agent.Dockerfile"
req "$AIRLOCK_ZSHRC"
req "$HOME/bin/yolo"
req "$HOME/bin/airlock-build"
req "$HOME/bin/airlock-doctor"

command -v "$AIRLOCK_ENGINE" >/dev/null || fail "container engine not found: $AIRLOCK_ENGINE"
if "$AIRLOCK_ENGINE" info >/dev/null 2>&1; then
  ok "engine reachable: $AIRLOCK_ENGINE"
else
  fail "engine not reachable (is it running and configured?): $AIRLOCK_ENGINE"
fi

if [[ "${AIRLOCK_MOUNT_ENGINE_SOCKET:-1}" != "0" ]]; then
  if [[ "$AIRLOCK_ENGINE" == "docker" ]]; then
    if [[ -S /var/run/docker.sock ]]; then
      ok "docker socket present: /var/run/docker.sock"
    else
      echo "WARN: docker socket not found at /var/run/docker.sock"
      echo "      Container builds from inside yolo will not work until the socket is available."
    fi
  elif [[ "$AIRLOCK_ENGINE" == "podman" ]]; then
    sock=""
    for candidate in \
      "/run/podman/podman.sock" \
      "${XDG_RUNTIME_DIR:-/run/user/$(id -u)}/podman/podman.sock" \
      "/run/user/$(id -u)/podman/podman.sock"
    do
      if [[ -S "$candidate" ]]; then
        sock="$candidate"
        break
      fi
    done

    if [[ -n "$sock" ]]; then
      ok "podman socket present: $sock"
    else
      echo "WARN: podman socket not found (podman CLI works, but builds from inside yolo need a socket)."
      echo "      Try enabling the user socket (systemd):"
      echo "        systemctl --user enable --now podman.socket"
      echo "      If user systemd isn't available, run a one-shot service instead:"
      echo "        podman system service --time=0 \"unix:///run/user/$(id -u)/podman/podman.sock\""
    fi
  fi
fi

IMAGE="${AIRLOCK_IMAGE:-airlock-agent:local}"
if "$AIRLOCK_ENGINE" image inspect "$IMAGE" >/dev/null 2>&1; then
  ok "agent image present: $IMAGE"
else
  echo "WARN: agent image missing: $IMAGE (run: airlock-build)"
fi

if [[ -f "$HOME/.codex/auth.json" ]]; then
  ok "codex auth present: $HOME/.codex/auth.json"
else
  echo "OK: codex auth not found (codex will prompt on first run)"
fi

opencode_data_dir="${AIRLOCK_HOST_OPENCODE_DATA_DIR:-$HOME/.local/share/opencode}"
if [[ -f "$opencode_data_dir/auth.json" ]]; then
  ok "opencode auth present: $opencode_data_dir/auth.json"
else
  echo "OK: opencode auth not found (opencode will prompt on first run)"
fi

ok "basic checks complete"
