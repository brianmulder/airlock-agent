#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'USAGE'
Usage: yolo [--] [command...]

Launch an ephemeral container with explicit mounts:
  - /work    (rw)  current directory
  - /context (ro)  Dropbox-mounted context folder
  - /drafts  (rw)  WSL-native outbox drafts

Examples:
  yolo
  yolo -- bash -lc 'id; mount | head'

Key env vars:
  AIRLOCK_ENGINE=docker|podman|nerdctl   Container engine command (default: docker)
  AIRLOCK_IMAGE=airlock-agent:local     Image tag to run
  AIRLOCK_CONTEXT_DIR=~/dropbox/fred    Host context directory (must exist)
  AIRLOCK_NETWORK=host                  Opt-in host networking (default: bridge)
  AIRLOCK_RM=0                          Keep container after exit (default: remove)
  AIRLOCK_TTY=0                         Disable -it (auto when attached to a tty)
  AIRLOCK_DRY_RUN=1                     Print the engine command and exit
USAGE
}

case "${1:-}" in
  -h|--help)
    usage
    exit 0
    ;;
esac
if [[ "${1:-}" == "--" ]]; then
  shift
fi

AIRLOCK_ENGINE="${AIRLOCK_ENGINE:-docker}"
AIRLOCK_IMAGE="${AIRLOCK_IMAGE:-airlock-agent:local}"

# Context: Dropbox-mounted in WSL (RO in container)
AIRLOCK_CONTEXT_DIR="${AIRLOCK_CONTEXT_DIR:-$HOME/dropbox/fred}"

# Hot-zone runtime state (WSL ext4, RW)
AIRLOCK_HOME="${AIRLOCK_HOME:-$HOME/.airlock}"
CODEX_STATE_DIR="${CODEX_STATE_DIR:-$AIRLOCK_HOME/codex-state}"
CACHE_DIR="${CACHE_DIR:-$AIRLOCK_HOME/cache}"
DRAFTS_DIR="${DRAFTS_DIR:-$AIRLOCK_HOME/outbox/drafts}"
POLICY_DIR="${POLICY_DIR:-$AIRLOCK_HOME/policy}"

# Policy files (stowed)
CODEX_CONFIG="${CODEX_CONFIG:-$POLICY_DIR/codex.config.toml}"
AGENTS_MD="${AGENTS_MD:-$POLICY_DIR/AGENTS.md}"
AIRLOCK_ZSHRC="${AIRLOCK_ZSHRC:-$POLICY_DIR/zshrc}"

# Workspace (must be a project repo in WSL ext4)
WORK_DIR="$(pwd)"

# Identity
AIRLOCK_UID="$(id -u)"
AIRLOCK_GID="$(id -g)"

command -v "$AIRLOCK_ENGINE" >/dev/null || {
  echo "ERROR: container engine not found: $AIRLOCK_ENGINE"
  echo "Set AIRLOCK_ENGINE=docker|podman|nerdctl (or adjust PATH)."
  exit 1
}

req_dir() { [[ -d "$1" ]] || { echo "ERROR: missing directory: $1" >&2; exit 1; }; }
req_file() { [[ -f "$1" ]] || { echo "ERROR: missing file: $1" >&2; exit 1; }; }

req_dir "$AIRLOCK_CONTEXT_DIR"
req_file "$CODEX_CONFIG"
req_file "$AGENTS_MD"
req_file "$AIRLOCK_ZSHRC"

# Prepare runtime dirs (avoid Docker creating root-owned dirs on host)
mkdir -p "$CODEX_STATE_DIR" "$CACHE_DIR" "$DRAFTS_DIR"

# Guardrail: drafts must not live under context (prevents RO-bypass footguns)
case "$DRAFTS_DIR" in
  "$AIRLOCK_CONTEXT_DIR"/*)
    echo "ERROR: DRAFTS_DIR is inside CONTEXT_DIR."
    echo "Move drafts out of Dropbox/context to keep RO boundary meaningful."
    exit 1
    ;;
esac

# Interactive args (allocates a tty only when attached to one, unless disabled).
TTY_ARGS=()
if [[ "${AIRLOCK_TTY:-}" != "0" ]] && [[ -t 0 && -t 1 ]]; then
  TTY_ARGS=(-it)
fi

# Remove container by default (set AIRLOCK_RM=0 to keep it).
RM_ARGS=()
if [[ "${AIRLOCK_RM:-1}" != "0" ]]; then
  RM_ARGS=(--rm)
fi

# Name (override for smoke tests / parallel runs)
AIRLOCK_CONTAINER_NAME="${AIRLOCK_CONTAINER_NAME:-airlock-$(basename "$WORK_DIR")}"

# Optional host networking
NETWORK_ARGS=()
if [[ "${AIRLOCK_NETWORK:-}" == "host" ]]; then
  NETWORK_ARGS+=(--network host)
fi

echo "--- Airlock YOLO ---"
echo "Engine:     $AIRLOCK_ENGINE"
echo "Image:      $AIRLOCK_IMAGE"
echo "Workspace:  $WORK_DIR -> /work (rw)"
echo "Context:    $AIRLOCK_CONTEXT_DIR -> /context (ro)"
echo "Drafts:     $DRAFTS_DIR -> /drafts (rw)"
echo "CODEX_HOME: /home/airlock/.codex (persisted)"
echo "Network:    ${AIRLOCK_NETWORK:-bridge}"
echo "Name:       $AIRLOCK_CONTAINER_NAME"
echo "---------------------"

cmd=(
  "$AIRLOCK_ENGINE" run
  "${TTY_ARGS[@]}"
  "${RM_ARGS[@]}"
  "${NETWORK_ARGS[@]}"
  --name "$AIRLOCK_CONTAINER_NAME"
  -e "AIRLOCK_UID=$AIRLOCK_UID"
  -e "AIRLOCK_GID=$AIRLOCK_GID"
  -e "HOME=/home/airlock"
  -e "CODEX_HOME=/home/airlock/.codex"
  -v "$WORK_DIR":/work:rw
  -w /work
  -v "$AIRLOCK_CONTEXT_DIR":/context:ro
  -v "$DRAFTS_DIR":/drafts:rw
  -v "$CODEX_STATE_DIR":/home/airlock/.codex:rw
  -v "$CODEX_CONFIG":/home/airlock/.codex/config.toml:ro
  -v "$AGENTS_MD":/home/airlock/.codex/AGENTS.md:ro
  -v "$CACHE_DIR":/home/airlock/.cache:rw
  -v "$CACHE_DIR/npm":/home/airlock/.npm:rw
  -v "$CACHE_DIR/pnpm":/home/airlock/.local/share/pnpm:rw
  -v "$AIRLOCK_ZSHRC":/home/airlock/.zshrc:ro
  "$AIRLOCK_IMAGE"
)

if (( $# > 0 )); then
  cmd+=("$@")
fi

if [[ "${AIRLOCK_DRY_RUN:-0}" == "1" ]]; then
  printf 'CMD:'
  printf ' %q' "${cmd[@]}"
  printf '\n'
  exit 0
fi

"${cmd[@]}"
