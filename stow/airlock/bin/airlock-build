#!/usr/bin/env bash
set -euo pipefail

script_dir="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
airlock_config="$script_dir/airlock-config"

if [[ -x "$airlock_config" ]]; then
  # shellcheck disable=SC1090
  eval "$("$airlock_config")"
fi

AIRLOCK_ENGINE="${AIRLOCK_ENGINE:-podman}"
AIRLOCK_IMAGE="${AIRLOCK_IMAGE:-airlock-agent:local}"

# Two-way door: swap base image without changing code
AIRLOCK_BASE_IMAGE="${AIRLOCK_BASE_IMAGE:-mcr.microsoft.com/devcontainers/javascript-node:20-bookworm}"

# Two-way door: pin or float Codex CLI
AIRLOCK_CODEX_VERSION="${AIRLOCK_CODEX_VERSION:-latest}"

# Two-way door: pin or float OpenCode CLI
AIRLOCK_OPENCODE_VERSION="${AIRLOCK_OPENCODE_VERSION:-latest}"

# Build cache control (optional)
AIRLOCK_NO_CACHE="${AIRLOCK_NO_CACHE:-0}"

# When using dist-tags like "latest", resolve to an exact version first to avoid container build caches
# pinning "latest" forever.
AIRLOCK_RESOLVE_LATEST="${AIRLOCK_RESOLVE_LATEST:-1}"
AIRLOCK_NPM_REGISTRY="${AIRLOCK_NPM_REGISTRY:-https://registry.npmjs.org}"

AIRLOCK_BUILD_ISOLATION="${AIRLOCK_BUILD_ISOLATION:-}"
AIRLOCK_BUILD_USERNS="${AIRLOCK_BUILD_USERNS:-}"
AIRLOCK_PULL="${AIRLOCK_PULL:-1}"
AIRLOCK_NPM_VERSION="${AIRLOCK_NPM_VERSION:-latest}"
AIRLOCK_EDITOR_PKG="${AIRLOCK_EDITOR_PKG:-vim-tiny}"

BUILD_CONTEXT="$HOME/.airlock/image"
DOCKERFILE="$BUILD_CONTEXT/agent.Dockerfile"

if [[ ! -f "$DOCKERFILE" ]]; then
  echo "ERROR: missing Dockerfile at $DOCKERFILE"
  echo "Did you stow the package?  stow -d <repo>/stow -t ~ airlock"
  exit 1
fi

image_input_sha() {
  local dir="$1"
  local -a hash_cmd
  if command -v sha256sum >/dev/null 2>&1; then
    hash_cmd=(sha256sum)
  elif command -v shasum >/dev/null 2>&1; then
    hash_cmd=(shasum -a 256)
  else
    echo "unknown"
    return 0
  fi

  local tmp
  tmp="$(mktemp)"
  # Stable: hash file contents + paths, then hash that list.
  find "$dir" -type f -print0 | LC_ALL=C sort -z | xargs -0 "${hash_cmd[@]}" >"$tmp"
  "${hash_cmd[@]}" "$tmp" | awk '{print $1}'
  rm -f "$tmp" || true
}

AIRLOCK_IMAGE_INPUT_SHA="${AIRLOCK_IMAGE_INPUT_SHA:-$(image_input_sha "$BUILD_CONTEXT")}"

urlencode_npm_pkg() {
  local pkg="$1"
  pkg="${pkg//@/%40}"
  pkg="${pkg//\//%2F}"
  printf '%s' "$pkg"
}

fetch_url() {
  local url="$1"
  if command -v curl >/dev/null 2>&1; then
    curl -fsSL "$url"
  elif command -v wget >/dev/null 2>&1; then
    wget -qO- "$url"
  else
    return 1
  fi
}

resolve_npm_dist_tag() {
  local pkg="$1"
  local tag="$2"

  local encoded url
  encoded="$(urlencode_npm_pkg "$pkg")"
  url="${AIRLOCK_NPM_REGISTRY%/}/${encoded}/${tag}"

  local version
  version="$(
    fetch_url "$url" | \
      grep -oE '"version"[[:space:]]*:[[:space:]]*"[^"]+"' | \
      head -n1 | \
      sed -E 's/^"version"[[:space:]]*:[[:space:]]*"([^"]+)".*/\1/'
  )" || return 1
  [[ -n "$version" ]] || return 1

  printf '%s' "$version"
}

CODEX_VERSION_FOR_BUILD="$AIRLOCK_CODEX_VERSION"
OPENCODE_VERSION_FOR_BUILD="$AIRLOCK_OPENCODE_VERSION"
NPM_VERSION_FOR_BUILD="$AIRLOCK_NPM_VERSION"

CODEX_VERSION_LABEL="$AIRLOCK_CODEX_VERSION"
OPENCODE_VERSION_LABEL="$AIRLOCK_OPENCODE_VERSION"
NPM_VERSION_LABEL="$AIRLOCK_NPM_VERSION"

if [[ "$AIRLOCK_RESOLVE_LATEST" != "0" ]]; then
  if [[ "$AIRLOCK_CODEX_VERSION" == "latest" ]]; then
    if resolved="$(resolve_npm_dist_tag "@openai/codex" "latest")"; then
      CODEX_VERSION_FOR_BUILD="$resolved"
      CODEX_VERSION_LABEL="latest (resolved $resolved)"
    else
      echo "WARN: failed to resolve @openai/codex@latest via $AIRLOCK_NPM_REGISTRY; using literal 'latest'." >&2
      echo "      Hint: container build caches may keep 'latest' pinned; try: AIRLOCK_NO_CACHE=1 airlock-build" >&2
    fi
  fi

  if [[ "$AIRLOCK_OPENCODE_VERSION" == "latest" ]]; then
    if resolved="$(resolve_npm_dist_tag "opencode-ai" "latest")"; then
      OPENCODE_VERSION_FOR_BUILD="$resolved"
      OPENCODE_VERSION_LABEL="latest (resolved $resolved)"
    else
      echo "WARN: failed to resolve opencode-ai@latest via $AIRLOCK_NPM_REGISTRY; using literal 'latest'." >&2
      echo "      Hint: container build caches may keep 'latest' pinned; try: AIRLOCK_NO_CACHE=1 airlock-build" >&2
    fi
  fi

  if [[ "$AIRLOCK_NPM_VERSION" == "latest" ]]; then
    if resolved="$(resolve_npm_dist_tag "npm" "latest")"; then
      NPM_VERSION_FOR_BUILD="$resolved"
      NPM_VERSION_LABEL="latest (resolved $resolved)"
    else
      echo "WARN: failed to resolve npm@latest via $AIRLOCK_NPM_REGISTRY; using literal 'latest'." >&2
      echo "      Hint: container build caches may keep 'latest' pinned; try: AIRLOCK_NO_CACHE=1 airlock-build" >&2
    fi
  fi
fi

command -v "$AIRLOCK_ENGINE" >/dev/null || {
  echo "ERROR: container engine not found: $AIRLOCK_ENGINE"
  echo "Set AIRLOCK_ENGINE=podman|docker|nerdctl (or adjust PATH)."
  exit 1
}

ENGINE_BUILD_ARGS=()
ENGINE_PULL_ARGS=()
ENGINE_CACHE_ARGS=()
if [[ "$AIRLOCK_PULL" == "0" ]]; then
  if [[ "$AIRLOCK_ENGINE" == "podman" ]]; then
    ENGINE_PULL_ARGS+=(--pull-never)
  fi
else
  ENGINE_PULL_ARGS+=(--pull)
fi
if [[ "$AIRLOCK_NO_CACHE" == "1" ]]; then
  ENGINE_CACHE_ARGS+=(--no-cache)
fi
if [[ "$AIRLOCK_ENGINE" == "podman" ]]; then
  # Podman can fail with OCI isolation due to runtime integration issues.
  # Default to chroot isolation unless explicitly overridden.
  if [[ -z "$AIRLOCK_BUILD_ISOLATION" ]]; then
    AIRLOCK_BUILD_ISOLATION="chroot"
  fi
  ENGINE_BUILD_ARGS+=(--isolation "$AIRLOCK_BUILD_ISOLATION")
  if [[ -n "$AIRLOCK_BUILD_USERNS" ]]; then
    ENGINE_BUILD_ARGS+=(--userns "$AIRLOCK_BUILD_USERNS")
  fi
fi

echo "--- Building Airlock agent image ---"
echo "Engine:     $AIRLOCK_ENGINE"
echo "Image:      $AIRLOCK_IMAGE"
echo "Base image: $AIRLOCK_BASE_IMAGE"
echo "Codex:      @openai/codex@$CODEX_VERSION_LABEL"
echo "OpenCode:   opencode-ai@$OPENCODE_VERSION_LABEL"
echo "npm:        npm@$NPM_VERSION_LABEL"
echo "Editor:     $AIRLOCK_EDITOR_PKG"
echo "Image input:$AIRLOCK_IMAGE_INPUT_SHA"
echo "Pull:       $AIRLOCK_PULL"
echo "No cache:   $AIRLOCK_NO_CACHE"
if [[ "${#ENGINE_BUILD_ARGS[@]}" -gt 0 ]]; then
  echo "Engine args:${ENGINE_BUILD_ARGS[*]}"
fi
echo "Context:    $BUILD_CONTEXT"
echo "---------------------------------------"

cmd=(
  "$AIRLOCK_ENGINE" build
  "${ENGINE_PULL_ARGS[@]}"
  "${ENGINE_CACHE_ARGS[@]}"
  -t "$AIRLOCK_IMAGE"
  --build-arg "BASE_IMAGE=$AIRLOCK_BASE_IMAGE"
  --build-arg "CODEX_VERSION=$CODEX_VERSION_FOR_BUILD"
  --build-arg "OPENCODE_VERSION=$OPENCODE_VERSION_FOR_BUILD"
  --build-arg "NPM_VERSION=$NPM_VERSION_FOR_BUILD"
  --build-arg "EDITOR_PKG=$AIRLOCK_EDITOR_PKG"
  --build-arg "AIRLOCK_IMAGE_INPUT_SHA=$AIRLOCK_IMAGE_INPUT_SHA"
  "${ENGINE_BUILD_ARGS[@]}"
  -f "$DOCKERFILE"
  "$BUILD_CONTEXT"
)

if [[ "${AIRLOCK_DRY_RUN:-0}" == "1" ]]; then
  printf 'CMD:'
  printf ' %q' "${cmd[@]}"
  printf '\n'
  exit 0
fi

"${cmd[@]}"
