#!/usr/bin/env bash
set -euo pipefail

AIRLOCK_ENGINE="${AIRLOCK_ENGINE:-podman}"
AIRLOCK_IMAGE="${AIRLOCK_IMAGE:-airlock-agent:local}"

# Two-way door: swap base image without changing code
AIRLOCK_BASE_IMAGE="${AIRLOCK_BASE_IMAGE:-mcr.microsoft.com/devcontainers/javascript-node:20-bookworm}"

# Two-way door: pin or float Codex CLI
AIRLOCK_CODEX_VERSION="${AIRLOCK_CODEX_VERSION:-latest}"

# Two-way door: pin or float OpenCode CLI
AIRLOCK_OPENCODE_VERSION="${AIRLOCK_OPENCODE_VERSION:-latest}"

AIRLOCK_BUILD_ISOLATION="${AIRLOCK_BUILD_ISOLATION:-}"
AIRLOCK_BUILD_USERNS="${AIRLOCK_BUILD_USERNS:-}"
AIRLOCK_PULL="${AIRLOCK_PULL:-1}"
AIRLOCK_NPM_VERSION="${AIRLOCK_NPM_VERSION:-latest}"
AIRLOCK_EDITOR_PKG="${AIRLOCK_EDITOR_PKG:-vim-tiny}"

BUILD_CONTEXT="$HOME/.airlock/image"
DOCKERFILE="$BUILD_CONTEXT/agent.Dockerfile"

if [[ ! -f "$DOCKERFILE" ]]; then
  echo "ERROR: missing Dockerfile at $DOCKERFILE"
  echo "Did you stow the package?  stow -d <repo>/stow -t ~ airlock"
  exit 1
fi

image_input_sha() {
  local dir="$1"
  local -a hash_cmd
  if command -v sha256sum >/dev/null 2>&1; then
    hash_cmd=(sha256sum)
  elif command -v shasum >/dev/null 2>&1; then
    hash_cmd=(shasum -a 256)
  else
    echo "unknown"
    return 0
  fi

  local tmp
  tmp="$(mktemp)"
  # Stable: hash file contents + paths, then hash that list.
  find "$dir" -type f -print0 | LC_ALL=C sort -z | xargs -0 "${hash_cmd[@]}" >"$tmp"
  "${hash_cmd[@]}" "$tmp" | awk '{print $1}'
  rm -f "$tmp" || true
}

AIRLOCK_IMAGE_INPUT_SHA="${AIRLOCK_IMAGE_INPUT_SHA:-$(image_input_sha "$BUILD_CONTEXT")}"

command -v "$AIRLOCK_ENGINE" >/dev/null || {
  echo "ERROR: container engine not found: $AIRLOCK_ENGINE"
  echo "Set AIRLOCK_ENGINE=podman|docker|nerdctl (or adjust PATH)."
  exit 1
}

ENGINE_BUILD_ARGS=()
ENGINE_PULL_ARGS=()
if [[ "$AIRLOCK_PULL" == "0" ]]; then
  if [[ "$AIRLOCK_ENGINE" == "podman" ]]; then
    ENGINE_PULL_ARGS+=(--pull-never)
  fi
else
  ENGINE_PULL_ARGS+=(--pull)
fi
if [[ "$AIRLOCK_ENGINE" == "podman" ]]; then
  # Podman can fail with OCI isolation due to runtime integration issues.
  # Default to chroot isolation unless explicitly overridden.
  if [[ -z "$AIRLOCK_BUILD_ISOLATION" ]]; then
    AIRLOCK_BUILD_ISOLATION="chroot"
  fi
  ENGINE_BUILD_ARGS+=(--isolation "$AIRLOCK_BUILD_ISOLATION")
  if [[ -n "$AIRLOCK_BUILD_USERNS" ]]; then
    ENGINE_BUILD_ARGS+=(--userns "$AIRLOCK_BUILD_USERNS")
  fi
fi

echo "--- Building Airlock agent image ---"
echo "Engine:     $AIRLOCK_ENGINE"
echo "Image:      $AIRLOCK_IMAGE"
echo "Base image: $AIRLOCK_BASE_IMAGE"
echo "Codex:      @openai/codex@$AIRLOCK_CODEX_VERSION"
echo "OpenCode:   opencode-ai@$AIRLOCK_OPENCODE_VERSION"
echo "npm:        npm@$AIRLOCK_NPM_VERSION"
echo "Editor:     $AIRLOCK_EDITOR_PKG"
echo "Image input:$AIRLOCK_IMAGE_INPUT_SHA"
echo "Pull:       $AIRLOCK_PULL"
if [[ "${#ENGINE_BUILD_ARGS[@]}" -gt 0 ]]; then
  echo "Engine args:${ENGINE_BUILD_ARGS[*]}"
fi
echo "Context:    $BUILD_CONTEXT"
echo "---------------------------------------"

cmd=(
  "$AIRLOCK_ENGINE" build
  "${ENGINE_PULL_ARGS[@]}"
  -t "$AIRLOCK_IMAGE"
  --build-arg "BASE_IMAGE=$AIRLOCK_BASE_IMAGE"
  --build-arg "CODEX_VERSION=$AIRLOCK_CODEX_VERSION"
  --build-arg "OPENCODE_VERSION=$AIRLOCK_OPENCODE_VERSION"
  --build-arg "NPM_VERSION=$AIRLOCK_NPM_VERSION"
  --build-arg "EDITOR_PKG=$AIRLOCK_EDITOR_PKG"
  --build-arg "AIRLOCK_IMAGE_INPUT_SHA=$AIRLOCK_IMAGE_INPUT_SHA"
  "${ENGINE_BUILD_ARGS[@]}"
  -f "$DOCKERFILE"
  "$BUILD_CONTEXT"
)

if [[ "${AIRLOCK_DRY_RUN:-0}" == "1" ]]; then
  printf 'CMD:'
  printf ' %q' "${cmd[@]}"
  printf '\n'
  exit 0
fi

"${cmd[@]}"
